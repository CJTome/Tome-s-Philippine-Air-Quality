<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="author" content="Ryan Agsaluna">
<meta name="description" content="Philippines Air Quality Heatmap with color-coded pollutant popups using OpenWeatherMap API">
<title>Philippines AQI Heatmap üå°Ô∏è</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
  }
  #map { 
    height: 90vh; 
    width: 100vw;   /* full viewport width */
    max-width: 100%; 
  }
  .legend {
    background: rgba(255,255,255,0.9);
    padding: 5px 8px;
    border-radius: 5px;
    font-size: 11px;
    line-height: 1.2;
    position: absolute;
    top: 10px;
    right: 10px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    z-index: 1000;
  }
  .legend div { display: flex; align-items: center; margin-bottom: 2px; }
  .color-box { width: 12px; height: 12px; margin-right: 4px; border-radius: 3px; }
  table { border-collapse: collapse; width: 100%; font-size: 12px; margin-top: 3px; }
  td, th { padding: 2px 4px; text-align: left; border-bottom: 1px solid #ddd; }
  .popup-legend { display:flex; flex-wrap: wrap; font-size: 10px; margin-top:4px; }
  .popup-legend div { display:flex; align-items:center; margin-right:5px; margin-bottom:2px; }
  .popup-legend .color-box { width:10px; height:10px; margin-right:3px; border-radius:2px; }
</style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-green-50 flex flex-col">

<header class="text-center p-4">
  <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-1">üå°Ô∏è Philippines Air Quality Heatmap</h1>
  <p class="text-gray-600 text-sm mb-2">Click a location to view detailed, color-coded pollutants with mini legend</p>

  <!-- Collapsible Instructions -->
  <div class="max-w-3xl mx-auto text-left">
    <button id="toggleInstructions" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded mb-2">
      Show Instructions
    </button>
    <div id="instructionsPanel" class="bg-white rounded-lg shadow-md p-3 text-gray-700 text-sm hidden">
      <h2 class="font-semibold mb-2">Instructions for Students:</h2>
      <ol class="list-decimal list-inside space-y-1">
        <li>Use your mouse or touch to navigate and zoom the map of the Philippines.</li>
        <li>Click on any city marker to view the detailed air quality information for that location.</li>
        <li>Each popup contains a table of pollutants with their real-time values (AQI, PM2.5, PM10, CO, NO, NO‚ÇÇ, O‚ÇÉ, SO‚ÇÇ, NH‚ÇÉ).</li>
        <li>The table rows are color-coded according to the severity of pollution using the mini legend below the table.</li>
        <li>Refer to the main legend on the top-right corner of the map to interpret AQI categories from Good to Hazardous.</li>
        <li>Observe trends across different cities and consider how pollution varies geographically.</li>
      </ol>
    </div>
  </div>
</header>

<!-- Full-width Map -->
<div id="map" class="rounded-none shadow-lg"></div>

<!-- Map Legend -->
<div class="legend">
  <div><div class="color-box" style="background:#009966"></div>Good (0-50)</div>
  <div><div class="color-box" style="background:#ffde33"></div>Moderate (51-100)</div>
  <div><div class="color-box" style="background:#ff9933"></div>Unhealthy for SG (101-150)</div>
  <div><div class="color-box" style="background:#cc0033"></div>Unhealthy (151-200)</div>
  <div><div class="color-box" style="background:#660099"></div>Very Unhealthy (201-300)</div>
  <div><div class="color-box" style="background:#7e0023"></div>Hazardous (301+)</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
const API_KEY = '022649ec1d8945301cbacda68d686488'; /* My API key in open weather */

const locations = [
  { name: "Manila", lat: 14.5995, lon: 120.9842 },
  { name: "Quezon City", lat: 14.6760, lon: 121.0437 },
  { name: "Cebu City", lat: 10.3157, lon: 123.8854 },
  { name: "Davao City", lat: 7.1907, lon: 125.4553 },
  { name: "Iloilo City", lat: 10.7202, lon: 122.5621 },
  { name: "Baguio City", lat: 16.4023, lon: 120.5960 },
  { name: "Zamboanga City", lat: 6.9214, lon: 122.0790 },
  { name: "Cagayan de Oro", lat: 8.4542, lon: 124.6319 },
  { name: "Bacolod", lat: 10.6760, lon: 122.9446 },
  { name: "Butuan", lat: 8.9478, lon: 125.5400 },
  { name: "Tagbilaran", lat: 9.6500, lon: 123.8500 },
  { name: "Olongapo", lat: 14.8396, lon: 120.2828 },
  { name: "Legazpi", lat: 13.1333, lon: 123.7333 },
  { name: "Tacloban", lat: 11.2449, lon: 125.0017 },
  { name: "Ormoc", lat: 11.0112, lon: 124.6071 },
  { name: "Surigao", lat: 9.7833, lon: 125.4833 },
  { name: "Malaybalay", lat: 8.1494, lon: 125.1322 },
  { name: "Pagadian", lat: 7.8289, lon: 123.4371 },
  { name: "Dipolog", lat: 8.5892, lon: 123.3500 },
  { name: "Sorsogon", lat: 12.9730, lon: 124.0130 },
  { name: "San Fernando, La Union", lat: 16.6135, lon: 120.3127 },
  { name: "Puerto Princesa", lat: 9.7401, lon: 118.7353 },
  { name: "Naga City", lat: 13.6194, lon: 123.1817 },
  { name: "Roxas City", lat: 11.5859, lon: 122.7535 },
  { name: "Calapan", lat: 13.4307, lon: 121.1744 },
  { name: "Catbalogan", lat: 11.7751, lon: 124.9245 },
  { name: "Baler", lat: 15.7569, lon: 121.5678 },
  { name: "Tuguegarao", lat: 17.6136, lon: 121.7269 },
  { name: "Cabanatuan", lat: 15.4840, lon: 120.9580 },
  { name: "San Jose del Monte", lat: 14.8036, lon: 121.0450 },
  { name: "Mati", lat: 6.9519, lon: 126.2246 },
  { name: "Bayawan", lat: 9.3450, lon: 123.1694 },
  { name: "Sagay", lat: 10.6758, lon: 123.0369 },
  { name: "Dumaguete", lat: 9.3123, lon: 123.3051 },
  { name: "Cauayan", lat: 16.9290, lon: 121.7740 },
  { name: "San Carlos", lat: 10.2890, lon: 123.7642 },
  { name: "Lucena", lat: 13.9414, lon: 121.6159 },
  { name: "Santa Rosa", lat: 14.3133, lon: 121.1097 },
  { name: "Mabalacat", lat: 15.2155, lon: 120.5970 },
  { name: "Tarlac City", lat: 15.4808, lon: 120.5990 },
  { name: "Malolos", lat: 14.8447, lon: 120.8112 },
  { name: "Tagum", lat: 7.4410, lon: 125.8050 },
  { name: "Bayugan", lat: 8.9848, lon: 125.6485 },
  { name: "Cotabato City", lat: 7.1970, lon: 124.2460 },
  { name: "Marawi", lat: 8.0000, lon: 124.2842 },
  { name: "Kidapawan", lat: 7.0381, lon: 125.0812 },
  { name: "Koronadal", lat: 6.4978, lon: 124.8489 },
  { name: "Tacurong", lat: 6.5849, lon: 124.7980 },
  { name: "Taytay", lat: 11.9413, lon: 119.6672 }
];

const map = L.map('map').setView([12.8797, 121.7740], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const heatPoints = [];

function getColor(value) {
  if(value <= 1) return '#009966';       
  else if(value <= 2) return '#ffde33';  
  else if(value <= 3) return '#ff9933';  
  else if(value <= 4) return '#cc0033';  
  else if(value <= 5) return '#660099';  
  else return '#7e0023';                 
}

const popupLegend = `
  <div class="popup-legend">
    <div><div class="color-box" style="background:#009966"></div>Good</div>
    <div><div class="color-box" style="background:#ffde33"></div>Moderate</div>
    <div><div class="color-box" style="background:#ff9933"></div>Unhealthy for SG</div>
    <div><div class="color-box" style="background:#cc0033"></div>Unhealthy</div>
    <div><div class="color-box" style="background:#660099"></div>Very Unhealthy</div>
    <div><div class="color-box" style="background:#7e0023"></div>Hazardous</div>
  </div>
`;

locations.forEach(location => {
  const url = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${location.lat}&lon=${location.lon}&appid=${API_KEY}`;
  
  fetch(url)
    .then(res => res.json())
    .then(data => {
      const aqi = data.list[0].main.aqi;
      const intensity = aqi / 5;
      heatPoints.push([location.lat, location.lon, intensity]);

      const comp = data.list[0].components;
      const pollutants = {
        "AQI": aqi,
        "PM2.5": comp.pm2_5,
        "PM10": comp.pm10,
        "CO": comp.co,
        "NO": comp.no,
        "NO‚ÇÇ": comp.no2,
        "O‚ÇÉ": comp.o3,
        "SO‚ÇÇ": comp.so2,
        "NH‚ÇÉ": comp.nh3
      };

      let tableRows = '';
      for (let [key, val] of Object.entries(pollutants)) {
        let scaled = val/50; 
        if (scaled > 5) scaled = 5;
        const color = getColor(scaled);
        tableRows += `<tr style="background:${color}; color:white;"><td>${key}</td><td>${val}</td></tr>`;
      }

      const popupContent = `<strong>${location.name}</strong>
                            <table>
                              <tr><th>Pollutant</th><th>Value</th></tr>
                              ${tableRows}
                            </table>
                            ${popupLegend}`;

      L.circleMarker([location.lat, location.lon], {
        radius: 5,
        color: '#000000',
        fillColor: '#ffffff',
        fillOpacity: 0.3
      }).addTo(map).bindPopup(popupContent);

      if (heatPoints.length === locations.length) {
        L.heatLayer(heatPoints, {
          radius: 25,
          blur: 15,
          maxZoom: 12,
          gradient: {
            0.0: '#009966',
            0.2: '#ffde33',
            0.4: '#ff9933',
            0.6: '#cc0033',
            0.8: '#660099',
            1.0: '#7e0023'
          }
        }).addTo(map);
      }
    })
    .catch(err => console.error("Error fetching AQI:", err));
});

const toggleBtn = document.getElementById('toggleInstructions');
const instructionsPanel = document.getElementById('instructionsPanel');

toggleBtn.addEventListener('click', () => {
  instructionsPanel.classList.toggle('hidden');
  toggleBtn.textContent = instructionsPanel.classList.contains('hidden') ? 'Show Instructions' : 'Hide Instructions';
});
</script>
</body>
</html>
